Sub ResumirMesasExamen()
    Dim oDoc As Object
    Dim oSheets As Object
    Dim oSheetOriginal As Object
    Dim oSheetResumido As Object
    Dim nFilaActual As Long
    Dim nFilaDestino As Long
    Dim sCellValue As String
    Dim nLastRow As Long
    Dim oDocBaseDatos As Object
    Dim sRutaBaseDatos As String
    
    ' Obtener el documento actual
    oDoc = ThisComponent
    oSheets = oDoc.Sheets
    
    ' Obtener la hoja original (asumimos que es la primera)
    oSheetOriginal = oSheets.getByIndex(0)
    
    ' Definir la ruta de la base de datos
    sRutaBaseDatos = "/home/cristian/Documentos/ALUMNOS/BASE DE DATOS/Base de datos de MESAS Y DOCENTES.ods"
    
    ' Intentar abrir el archivo de base de datos
    oDocBaseDatos = AbrirBaseDatos(sRutaBaseDatos)
    
    ' Si no se pudo abrir, terminar la macro
    If IsNull(oDocBaseDatos) Then
        MsgBox "No se pudo abrir la base de datos. La macro se detendrá.", 16, "Error"
        Exit Sub
    End If
    
    ' Crear nueva hoja "RESUMIDO" si no existe
    If oSheets.hasByName("RESUMIDO") Then
        oSheets.removeByName("RESUMIDO")
    End If
    oSheets.insertNewByName("RESUMIDO", oSheets.getCount())
    oSheetResumido = oSheets.getByName("RESUMIDO")
    
    ' Crear encabezados en la hoja RESUMIDO (ahora con 3 columnas para docentes)
    oSheetResumido.getCellByPosition(0, 0).setString("Materia")
    oSheetResumido.getCellByPosition(1, 0).setString("Fecha")
    oSheetResumido.getCellByPosition(2, 0).setString("Hora")
    oSheetResumido.getCellByPosition(3, 0).setString("Presidente")
    oSheetResumido.getCellByPosition(4, 0).setString("Vocal 1")
    oSheetResumido.getCellByPosition(5, 0).setString("Vocal 2")
    
    ' Determinar la última fila con datos
    nLastRow = 1500 ' Por seguridad, iteramos hasta la fila 1500
    
    ' Inicializar fila de destino
    nFilaDestino = 1
    
    ' Recorrer la hoja original buscando nombres de materias
    nFilaActual = 5 ' Comenzar desde la fila 6 (índice 5)
    
    While nFilaActual < nLastRow
        sCellValue = Trim(oSheetOriginal.getCellByPosition(0, nFilaActual).getString())
        
        ' Verificar si la celda contiene un código de materia (formato: número entre paréntesis)
        If Len(sCellValue) > 0 And Left(sCellValue, 1) = "(" Then
            ' Leer el subtítulo (una fila después del nombre de la materia)
            Dim sSubtitulo As String
            sSubtitulo = Trim(oSheetOriginal.getCellByPosition(0, nFilaActual + 1).getString())
            
            ' Filtrar: excluir si contiene "Libre" o "El Maiten"
            Dim bIncluirMesa As Boolean
            bIncluirMesa = True
            
            If InStr(1, sSubtitulo, "Libre", 1) > 0 Then
                bIncluirMesa = False
            End If
            
            If InStr(1, sSubtitulo, "El Maiten", 1) > 0 Then
                bIncluirMesa = False
            End If
            
            ' Solo procesar si la mesa pasa los filtros
            If bIncluirMesa Then
                ' Copiar nombre de la materia
                oSheetResumido.getCellByPosition(0, nFilaDestino).setString(sCellValue)
                
                ' Buscar la fila con los datos (3 filas más abajo)
                Dim nFilaDatos As Long
                nFilaDatos = nFilaActual + 3
            
                ' Verificar que la fila de datos existe y contiene información
                If nFilaDatos < nLastRow Then
                    ' Copiar Fecha (columna B)
                    Dim sFecha As String
                    sFecha = Trim(oSheetOriginal.getCellByPosition(1, nFilaDatos).getString())
                    oSheetResumido.getCellByPosition(1, nFilaDestino).setString(sFecha)
                    
                    ' Copiar Hora (columna C)
                    Dim sHora As String
                    sHora = Trim(oSheetOriginal.getCellByPosition(2, nFilaDatos).getString())
                    oSheetResumido.getCellByPosition(2, nFilaDestino).setString(sHora)
                    
                    ' Buscar los docentes en la base de datos externa
                    Dim sPresidente As String
                    Dim sVocal1 As String
                    Dim sVocal2 As String
                    
                    ' Buscar la materia en la base de datos
                    BuscarDocentesEnBaseDatos(oDocBaseDatos, sCellValue, sPresidente, sVocal1, sVocal2)
                    
                    ' Escribir los docentes en las columnas correspondientes
                    oSheetResumido.getCellByPosition(3, nFilaDestino).setString(sPresidente) ' Presidente
                    oSheetResumido.getCellByPosition(4, nFilaDestino).setString(sVocal1)      ' Vocal 1
                    oSheetResumido.getCellByPosition(5, nFilaDestino).setString(sVocal2)      ' Vocal 2
                End If
                
                ' Incrementar fila de destino
                nFilaDestino = nFilaDestino + 1
            End If ' Fin del filtro bIncluirMesa
        End If
        
        ' Avanzar a la siguiente fila
        nFilaActual = nFilaActual + 1
    Wend
    
    ' Cerrar el documento de base de datos
    oDocBaseDatos.close(True)
    
    ' Ajustar ancho de columnas automáticamente (ahora son 6 columnas)
    Dim i As Integer
    For i = 0 To 5
        oSheetResumido.getColumns().getByIndex(i).OptimalWidth = True
    Next i
    
    ' Activar la hoja RESUMIDO
    oDoc.getCurrentController().setActiveSheet(oSheetResumido)
    
    MsgBox "Proceso completado. Se procesaron " & (nFilaDestino - 1) & " materias.", 0, "Resumen de Mesas"
    
End Sub

' Función para abrir la base de datos
Function AbrirBaseDatos(sRutaArchivo As String) As Object
    Dim oDocBaseDatos As Object
    Dim oFileAccess As Object
    Dim bArchivoExiste As Boolean
    
    ' Crear objeto para verificar si el archivo existe
    oFileAccess = CreateUnoService("com.sun.star.ucb.SimpleFileAccess")
    
    ' Verificar si el archivo existe
    On Error Resume Next
    bArchivoExiste = oFileAccess.exists(ConvertToURL(sRutaArchivo))
    On Error Goto 0
    
    If bArchivoExiste Then
        ' El archivo existe, intentar abrirlo
        On Error Resume Next
        oDocBaseDatos = StarDesktop.loadComponentFromURL(ConvertToURL(sRutaArchivo), "_blank", 0, Array())
        On Error Goto 0
        
        If Not IsNull(oDocBaseDatos) Then
            AbrirBaseDatos = oDocBaseDatos
            Exit Function
        End If
    End If
    
    ' Si llegamos aquí, el archivo no existe o no se pudo abrir
    ' Mostrar diálogo para seleccionar el archivo manualmente
    MsgBox "No se encontró el archivo de base de datos en la ruta predeterminada." & Chr(10) & _
           sRutaArchivo & Chr(10) & Chr(10) & _
           "Por favor, seleccione el archivo manualmente.", 48, "Archivo no encontrado"
    
    Dim oFilePicker As Object
    Dim sArchivoSeleccionado As String
    
    ' Crear el selector de archivos
    oFilePicker = CreateUnoService("com.sun.star.ui.dialogs.FilePicker")
    
    ' Configurar el filtro para archivos .ods
    oFilePicker.appendFilter("Archivos de LibreOffice Calc (*.ods)", "*.ods")
    oFilePicker.appendFilter("Todos los archivos (*.*)", "*.*")
    oFilePicker.setCurrentFilter("Archivos de LibreOffice Calc (*.ods)")
    
    ' Establecer el directorio inicial (si es posible)
    On Error Resume Next
    oFilePicker.setDisplayDirectory(ConvertToURL("/home/cristian/Documentos/"))
    On Error Goto 0
    
    ' Mostrar el diálogo
    If oFilePicker.execute() = 1 Then
        sArchivoSeleccionado = oFilePicker.getFiles()(0)
        
        ' Intentar abrir el archivo seleccionado
        On Error Resume Next
        oDocBaseDatos = StarDesktop.loadComponentFromURL(sArchivoSeleccionado, "_blank", 0, Array())
        On Error Goto 0
        
        If Not IsNull(oDocBaseDatos) Then
            AbrirBaseDatos = oDocBaseDatos
            Exit Function
        End If
    End If
    
    ' Si llegamos aquí, no se pudo abrir ningún archivo
    AbrirBaseDatos = Null
    
End Function

' Función para convertir ruta a URL
Function ConvertToURL(sRuta As String) As String
    Dim oPathSettings As Object
    
    ' Si ya es una URL, devolverla tal cual
    If Left(sRuta, 7) = "file://" Then
        ConvertToURL = sRuta
        Exit Function
    End If
    
    ' Convertir ruta del sistema a URL
    oPathSettings = CreateUnoService("com.sun.star.util.PathSubstitution")
    ConvertToURL = oPathSettings.substituteVariables("file://" & sRuta, True)
    
End Function

' Función para buscar los docentes en la base de datos
Sub BuscarDocentesEnBaseDatos(oDocBD As Object, sCodigoMateria As String, _
                                sPresidente As String, sVocal1 As String, sVocal2 As String)
    Dim oSheetBD As Object
    Dim nFila As Long
    Dim sCodigoBD As String
    Dim bEncontrado As Boolean
    
    ' Inicializar variables de salida
    sPresidente = ""
    sVocal1 = ""
    sVocal2 = ""
    bEncontrado = False
    
    ' Obtener la primera hoja de la base de datos
    oSheetBD = oDocBD.Sheets.getByIndex(0)
    
    ' Buscar desde la fila 6 (índice 5) hasta la fila 230
    For nFila = 5 To 229
        ' Leer el código de materia de la columna A (índice 0)
        sCodigoBD = Trim(oSheetBD.getCellByPosition(0, nFila).getString())
        
        ' Comparar códigos (sin distinguir mayúsculas/minúsculas)
        If UCase(sCodigoBD) = UCase(sCodigoMateria) Then
            ' Encontramos la materia, leer los docentes
            sPresidente = Trim(oSheetBD.getCellByPosition(4, nFila).getString()) ' Columna E
            sVocal1 = Trim(oSheetBD.getCellByPosition(5, nFila).getString())     ' Columna F
            sVocal2 = Trim(oSheetBD.getCellByPosition(6, nFila).getString())     ' Columna G
            bEncontrado = True
            Exit For
        End If
    Next nFila
    
    ' Si no se encontró, marcar como no encontrado
    If Not bEncontrado Then
        sPresidente = "[NO ENCONTRADO]"
        sVocal1 = ""
        sVocal2 = ""
    End If
    
End Sub
